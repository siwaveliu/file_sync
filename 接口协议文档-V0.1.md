---
title: 接口协议文档-V0.1 
tags: PLC,协议,V0.1
slug: 矽久/出厂测试平台文档
grammar_abbr: true
grammar_table: true
grammar_defList: true
grammar_emoji: true
grammar_footnote: true
grammar_ins: true
grammar_mark: true
grammar_sub: true
grammar_sup: true
grammar_checkbox: true
grammar_mathjax: true
grammar_flow: true
grammar_sequence: true
grammar_plot: true
grammar_code: true
grammar_highlight: true
grammar_html: true
grammar_linkify: true
grammar_typographer: true
grammar_video: true
grammar_audio: true
grammar_attachment: true
grammar_mermaid: true
grammar_classy: true
grammar_cjkEmphasis: true
grammar_cjkRuby: true
grammar_center: true
grammar_align: true
grammar_tableExtra: true
grammar_mindmap: true
---


[toc]

___
# 基本内容
## 名词解释
工装：测试板和测试夹具结合体，与pc通过uart相连
上位机：运行在pc上的控制程序，控制工装的测试流程。
标准模块：事先由矽久提供性能标准的模块，主要用来检验工装状态。
工装ID：每个工装使用前需要设置唯一的ID。
uart参数：*921600，N，8，1*（暂定）
模块标识符：模块烧写程序后产生，用于追溯模块生产流程。

## 协议报文结构
ED报文结构：head +data（u8的数组） +tail
head中包括 start_char(0xED) + length + cf+rsv
tail中包括 cs + end_char(0xEE)，cs是check_sum,(从cf开始到cs结束，不包括cs）。
![enter description here](./images/接口协议图1.png)
>下行报文cf1=0x03，cf2=N；
上行报文cf1=0x83，cf2=N；
Cf1的第8bit表示方向，下行 bit=0，上行bit=1。

## 测试项命令
  cf=*0x03N*(cf1=0x03,cf2=**N**)  data=**X + DATA**
  **N:** 
1. 工装自检
2. 程序烧写[^1x]
[^1x]:暂不使用，目前是单独流程
3.PIN和电压测试[^2x]
[^2x]:TXD/RXD/RST/EVENT/PLUG/STA/CAP/1.2V/3.3V/12V-boost
4.  版本号验证
5.  通信测试[^3x]
[^3x]:包含接收SNR、平坦度、发送RSSI和通信成功率
6.  频偏测试
7.  功耗测试[^4x]
[^4x]:包括静态功耗和动态功耗
8.  过零电路测试
9.  停电上报测试
10. 模块ID和芯片ID写入校验[^5x]
[^5x]:暂不使用，单独流程
**X:** 01 启动 ，02 停止，03 结果
**DATA:** 依测试项不同而定
## 确认帧
所有指令应在100ms内回复，确认帧表示已经收到指令；同样的，当上位机软件收到工装上报的结果报文，也需要回复确认帧。
 cf=0x03CF data=0xFF 0xFF（异常数据 data = XX XX，后续定义）
 测试板回复：ED 00 08 83 CF 00 00 00 FF FF 00 EE （测试板回复表示上行，最高bit置1）
上位机回复： ED 00 08 03 CF 00 00 00 FF FF 00 EE

## 例子：
名称|帧内容（cs缺省为0）
---|---
启动工装自检| ED 00 07 ==03 01== 00 00 00  ***{01}(X)*** 00 EE 
      回复         |ED 00 07 ==83 CF== 00 00 00 FF FF 00 EE
停止工装自检 |ED 00 07 ==03 01== 00 00 00  ***{02}(X)*** 00 EE
       回复        |ED 00 07 ==83 CF== 00 00 00 FF FF 00 EE

---	
# 测试项
## 工装自检
原则上，每天**第一次**使用工装和工装连续使用**2000**次时都需要启动工装自检流程，以检验工装有效性。没有通过自检流程，则不允许生产。
### 流程
```flow!
st=>start: 开始
e=>end: 结束
op=>operation: 启动自检
op1=>operation: 工装回复确认
op2=>operation: 插入标准模块
op3=>operation: 工装自检
op4=>operation: 工装上报自检结果
op5=>operation: 上位机回复确认
op6=>operation: 上位机显示
cond=>condition: 正常 or 异常?

st->op->op1->op2->op3->op4->op5->op6->cond
cond(yes)->e
cond(no)->op
```
### 交互报文
结果上报报文中的DATA项含义依次为：
**DATA：**
|名称|列1|列2|列3|列4|
|-|-|-|-|-|
字节序号|0|1|2|3
含义|总结果|PIN和电压|版本号|衰减电路
字节序号|4|5|6|7
含义|频偏测试|功耗测试|过零电路|停电上报
[**工装字节data区**]
每项占用一个字节，01表示pass；02表示fail；
 
名称|帧内容
-|-
启动自检|ED 00 07 ==03 01== 00 00 00  **{01}(X)** 00 EE 
 停止自检 |ED 00 07 ==03 01== 00 00 00 **{02}(X)** 00 EE
工装上报结果|ED 00 14 ==83 01== 00 00 00 **{03}(X)** ***{02}(DATA:0) {01}(1) {01}(2) {01}(3) {01}(4) {02}(5) {01}(6) {01}(7)*** 00 EE 该条表示自检结果失败，其中功耗电路自检fail。

##  PIN和电压测试 
包含RXD/RST/EVENT/PLUG/TXD/STA/CAP/1.2V/3.3V/12V
其中TXD/STA/CAP/1.2V/3.3V/12V会通过ADC来测量电平值
### 流程
```flow!
st=>start: 开始
e=>end: 结束
op=>operation: 启动PIN和电源电压测试
op1=>operation: 工装回复确认
op4=>operation: 工装上报信息
op5=>operation: 上位机回复确认
op6=>operation: 上位机判定并显示结果

st->op->op1->op4->op5->op6->e
```
### 交互报文
电平值使用2字节BCD码表示；高字节表示整数，低字节表示小数；如0x1189，表示为11.89V
**DATA：**
|名称|列1|列2|列3|列4|
|-|-|-|-|-|
字节序号|0|1|2|3
含义|RXD结果|RST结果|EVENT结果|PLUG结果
字节序号|4|5|6|7
含义|TXD结果|STA结果|CAP结果|1.2V结果
字节序号|8|9|10|11
含义|3.3V结果|12V结果|TXD_H|TXD_L
字节序号|12|13|14|15
含义|STA_H|STA_L|CAP_H|CAP_L
字节序号|16|17|18|19
含义|1.2_H|1.2_L|3.3_H|3.3_L
字节序号|20|21|
含义|12_H|12_L|

名称|帧内容
启动版本号测试|ED 00 07 ==03 04== 00 00 00  **{01}(X)** 00 EE 
停止版本号测试|ED 00 07 ==03 04== 00 00 00  **{02}(X)** 00 EE 
## 版本号验证
从模块中读取**软硬件版本号**和上位机中预置值进行比较。
### 流程
```flow!
st=>start: 开始
e=>end: 结束
op=>operation: 启动版本号测试
op1=>operation: 工装回复确认
op4=>operation: 工装上报信息
op5=>operation: 上位机回复确认
op6=>operation: 上位机判定并显示结果

st->op->op1->op4->op5->op6->e
```

### 交互报文
**DATA：**
0.软件版本高字节
1.软件版本低字节
2.硬件版本高字节
3.硬件版本低字节

名称|帧内容
-|-
启动版本号测试|ED 00 07 ==03 04== 00 00 00  **{01}(X)** 00 EE 
停止版本号测试|ED 00 07 ==03 04== 00 00 00  **{02}(X)** 00 EE 
版本号测试结果|ED 00 0B ==03 04== 00 00 00  **{03}(X)** ***{10 01}(软件版本) {20 01}(硬件版本)*** 00 EE  DATA区4个字节，大端显示格式。1001表示1.0.01软件版本，2001表示2.0.01硬件版本。